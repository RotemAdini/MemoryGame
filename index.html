<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>משחק הזיכרון הגדול</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100dvh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #0a0a23 0%, #1a1a3a 30%, #2d1b69 60%, #8b2b9b 100%);
            color: white;
            text-align: center;
            position: relative;
        }

        /* אנימציית רקע משופרת */
        .synthwave-grid {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) perspective(500px) rotateX(60deg);
            width: 200%;
            height: 50vh;
            background-image: 
                linear-gradient(rgba(255, 0, 150, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 150, 0.3) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 10s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        /* אנימציות משופרות */
        @keyframes gridMove {
            0% { transform: translateX(-50%) perspective(500px) rotateX(60deg) translateZ(0); }
            100% { transform: translateX(-50%) perspective(500px) rotateX(60deg) translateZ(40px); }
        }

        @keyframes slideInFromRight {
            0% { 
                opacity: 0; 
                transform: translateX(100%); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes slideInFromLeft {
            0% { 
                opacity: 0; 
                transform: translateX(-100%); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes fadeInUp {
            0% { 
                opacity: 0; 
                transform: translateY(50px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes zoomIn {
            0% { 
                opacity: 0; 
                transform: scale(0.8) rotate(-5deg); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 0, 132, 0.5);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 0, 132, 0.8), 0 0 60px rgba(0, 255, 255, 0.4);
            }
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            75% { transform: translateY(-5px) rotate(-3deg); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes buttonHover {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
            100% { transform: translateY(-5px) scale(1.03); }
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0) rotateX(0); }
            50% { transform: translateY(-10px) rotateX(2deg); }
        }

        .container {
            width: 100vw;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .screen {
            display: none !important;
            width: 100%;
            height: 100%;
        }

        .screen.active {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            height: 100dvh;
            overflow: hidden;
            padding: 20px;
            animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .screen.slide-right {
            animation: slideInFromRight 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .screen.slide-left {
            animation: slideInFromLeft 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .screen.zoom {
            animation: zoomIn 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* מבנה כללי למסכים רגילים */
        .screen-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 900px;
        }

        .screen-actions {
            padding: 20px 0;
            width: 100%;
            max-width: 600px;
        }

        /* מסך המשחק - מבנה שונה */
        #game-screen.active {
            justify-content: flex-start;
            padding-top: 60px;
        }

        #game-screen .game-header {
            width: 100%;
            max-width: 900px;
        }

        #game-screen .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 900px;
        }

        #game-screen .game-controls {
            padding: 20px 0;
            width: 100%;
            max-width: 600px;
        }

        .title {
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #fff, #f0f0f0, #fff);
            background-size: 200% 200%;
            animation: shimmer 3s ease-in-out infinite, pulse 3s infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: clamp(1rem, 3vw, 1.3rem);
            margin-bottom: 1.5rem;
            opacity: 0.9;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        .card {
            background: rgba(26, 0, 51, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: clamp(1.5rem, 4vw, 2.5rem);
            margin: 1rem 0;
            border: 2px solid #ff0084;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(255, 0, 132, 0.3),
                inset 0 0 30px rgba(0, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            width: 100%;
            max-width: 600px;
            animation: cardFloat 4s ease-in-out infinite;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.02);
            animation-play-state: paused;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 50px rgba(255, 0, 132, 0.5),
                inset 0 0 40px rgba(0, 255, 255, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #ff0084, #00ffff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: bold;
            cursor: pointer;
            margin: 10px auto;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 0, 132, 0.5);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            display: block;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            animation: buttonHover 0.6s ease-out;
            animation-fill-mode: forwards;
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(255, 0, 132, 0.8),
                0 0 60px rgba(0, 255, 255, 0.4);
        }

        .btn:active {
            transform: scale(0.95) translateY(-2px);
            transition: transform 0.1s ease-out;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            animation: glowPulse 3s infinite;
        }

        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        .btn-share {
            background: linear-gradient(45deg, #25D366, #128C7E);
        }

        .input-group {
            margin: 1rem 0;
            text-align: center;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
        }

        .input-group input, .input-group select {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border-radius: 20px;
            border: none;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            margin: 0 auto;
            display: block;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 132, 0.5);
        }

        .players-info {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-card {
            flex: 1;
            min-width: 140px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 2px solid transparent;
        }

        .player-card:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 0, 132, 0.5);
            transform: translateY(-5px);
        }

        .player-card:nth-child(2) {
            flex: 1.5;
        }

        .failures {
            color: #ff6b6b;
            font-weight: bold;
            font-size: 1rem;
            margin-top: 5px;
            animation: iconBounce 2s infinite;
        }

        .question-card {
            background: rgba(26, 0, 51, 0.4);
            border-radius: 30px;
            padding: clamp(2rem, 5vw, 4rem) clamp(1.5rem, 4vw, 3rem);
            margin: 1.5rem 0;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            line-height: 1.8;
            border: 3px solid #00ffff;
            box-shadow: 
                0 15px 50px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(0, 255, 255, 0.4),
                inset 0 0 40px rgba(255, 0, 132, 0.1);
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            width: 100%;
            max-width: 700px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: cardFloat 6s ease-in-out infinite;
        }

        .question-card:hover {
            transform: translateY(-5px) scale(1.02);
            animation-play-state: paused;
        }

        .chapter-title {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: bold;
            margin: 2rem 0;
            text-align: center;
            background: linear-gradient(45deg, #ffeaa7, #fab1a0, #ffeaa7);
            background-size: 200% 200%;
            animation: shimmer 2s ease-in-out infinite, pulse 2s infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .timer {
            font-size: clamp(5rem, 20vw, 10rem);
            font-weight: bold;
            margin: 2rem 0;
            text-shadow: 5px 5px 10px rgba(0,0,0,0.7);
            animation: pulse 1s infinite, glowPulse 2s infinite;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 1.5rem auto;
            width: 100%;
            max-width: 600px;
        }

        .controls .btn {
            width: 100%;
            padding: 15px;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            margin: 0;
            display: inline-block;
        }

        .secondary-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 1rem auto;
            max-width: 600px;
        }

        .secondary-controls .btn {
            display: inline-block;
            margin: 0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            padding: 10px 20px;
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.5s ease-out;
        }

        .popup-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: clamp(2rem, 5vw, 3rem);
            border-radius: 30px;
            text-align: center;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: zoomIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .popup-content .btn {
            display: inline-block;
            margin: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 40px;
            margin: 0 15px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 40px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .slider:hover:before {
            box-shadow: 0 0 15px rgba(255, 0, 132, 0.5);
        }

        .score-animation {
            font-size: 4rem;
            font-weight: bold;
            color: #4ecdc4;
            transition: all 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .celebration {
            animation: pulse 0.5s infinite alternate;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .info-box:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 0, 132, 0.5);
        }

        .sensual-warning {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            margin: 1rem 0;
            font-weight: bold;
            animation: pulse 2s infinite;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
        }

        .settings-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 0, 132, 0.5);
        }

        /* כפתור שליטה על הצליל */
        .sound-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
        }

        .sound-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .sound-btn.muted {
            background: rgba(255, 107, 107, 0.3);
            border-color: rgba(255, 107, 107, 0.5);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ff0084;
            animation: confetti 3s linear;
            z-index: 1001;
        }

        .confetti:nth-child(even) {
            background: #00ffff;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            background: #ffeaa7;
            animation-delay: 0.3s;
        }

        /* אייקונים אינטראקטיביים */
        .interactive-icon {
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }

        .interactive-icon:hover {
            animation: iconBounce 0.6s ease-out;
            filter: drop-shadow(0 0 10px rgba(255, 0, 132, 0.8));
        }

        /* אופטימיזציה למובייל */
        @media (max-width: 768px) {
            .synthwave-grid {
                display: none;
            }
            
            .screen.active {
                padding: 10px;
            }
            
            #game-screen.active {
                padding-top: 50px;
            }
            
            .title { 
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            
            .subtitle { 
                font-size: 1rem;
                margin-bottom: 1rem;
            }
            
            .card {
                padding: 1.2rem;
                margin: 0.5rem 0;
            }
            
            .players-info { 
                gap: 5px;
            }
            
            .player-card {
                padding: 0.7rem;
                min-width: 100px;
                font-size: 0.9rem;
            }
            
            .question-card { 
                font-size: 1.1rem;
                padding: 1.5rem 1rem;
                margin: 1rem 0;
                min-height: 120px;
            }
            
            .controls { 
                gap: 8px;
                margin: 1rem 0;
            }
            
            .controls .btn {
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            
            .secondary-controls {
                gap: 8px;
                margin: 0.5rem 0;
            }
            
            .secondary-controls .btn {
                font-size: 0.75rem;
                padding: 8px 15px;
            }
            
            .btn { 
                font-size: 1rem;
                padding: 12px 25px;
            }
            
            .timer { 
                font-size: 4rem;
                margin: 1.5rem 0;
            }
            
            .chapter-title {
                font-size: 1.5rem;
                margin: 1.5rem 0;
            }
            
            .settings-btn, .sound-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                top: 10px;
            }
            
            .settings-btn {
                left: 10px;
            }
            
            .sound-btn {
                right: 10px;
            }
            
            .popup-content {
                padding: 1.5rem;
                max-height: 85vh;
            }
            
            .popup-content .btn {
                font-size: 0.9rem;
                padding: 10px 20px;
                margin: 5px;
            }
            
            .info-box {
                padding: 1rem;
                margin: 1rem 0;
            }
            
            .sensual-warning {
                padding: 0.8rem;
                font-size: 0.85rem;
            }
            
            ul {
                font-size: 0.95rem;
                line-height: 2;
            }
            
            .progress-bar {
                height: 8px;
            }
        }

        /* מסכים קטנים מאוד */
        @media (max-width: 360px) {
            .title { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            .question-card { font-size: 0.95rem; padding: 1rem; }
            .controls .btn { font-size: 0.75rem; padding: 10px 5px; }
            .player-card { font-size: 0.8rem; padding: 0.5rem; }
        }

        /* גבהים נמוכים */
        @media (max-height: 600px) {
            .screen.active { padding: 5px; }
            #game-screen.active { padding-top: 40px; }
            .title { margin-bottom: 0.5rem; }
            .card { margin: 0.3rem 0; padding: 1rem; }
            .question-card { margin: 0.5rem 0; padding: 1rem; min-height: 80px; }
            .controls { margin: 0.5rem 0; }
            .timer { font-size: 3rem; margin: 1rem 0; }
        }

        /* תיקון למסך הסבר כדי שהכפתור יהיה נגיש */
        @media (max-height: 750px) {
            #rules-screen ul {
                font-size: 1rem;
                line-height: 1.8;
            }
            
            #rules-screen .info-box {
                padding: 1rem;
                margin: 0.8rem 0;
            }
            
            #rules-screen .card {
                padding: 1.5rem;
                margin: 0.5rem 0;
            }
            
            #rules-screen .title {
                font-size: 2rem;
                margin-bottom: 1rem;
            }
        }

        @media (max-height: 650px) {
            #rules-screen ul {
                font-size: 0.9rem;
                line-height: 1.6;
            }
            
            #rules-screen .info-box {
                padding: 0.8rem;
                margin: 0.5rem 0;
            }
            
            #rules-screen .sensual-warning {
                padding: 0.6rem;
                font-size: 0.8rem;
            }
            
            #rules-screen .title {
                font-size: 1.8rem;
                margin-bottom: 0.8rem;
            }
        }

        /* הוספת מחלקות נגישות */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* סגנון לכפתורים נגישים */
        .btn:focus {
            outline: 3px solid rgba(255, 255, 255, 0.7);
            outline-offset: 2px;
        }

        /* הודעת שגיאה */
        .error-message {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            margin: 1rem 0;
            font-weight: bold;
            animation: pulse 1s;
        }
    </style>
</head>
<body>
    <div class="synthwave-grid"></div>
    
    <button class="settings-btn interactive-icon" onclick="openSettings()" title="הגדרות" aria-label="פתח הגדרות">⚙️</button>
    <button class="sound-btn interactive-icon" onclick="toggleSound()" title="הפעל/כבה צלילים" id="sound-toggle" aria-label="הפעל או כבה צלילים">🔊</button>

    <div class="container">
        <!-- מסך ברוכים הבאים -->
        <div id="welcome-screen" class="screen active" role="main">
            <div class="screen-content">
                <div class="title">🎮 משחק הזיכרון הגדול 🎮</div>
                <div class="subtitle">המשחק הזוגי שיבדק כמה טוב אתם מכירים אחד את השני!</div>
                <div class="card">
                    <p>ברוכים הבאים למשחק הכי מהנה לזוגות! <span class="interactive-icon">💕</span></p>
                    <p>40 שאלות זיכרון מיוחדות שיעוררו זיכרונות מתוקים ויצחקו אתכם</p>
                </div>
            </div>
            <div class="screen-actions">
                <button class="btn" onclick="nextScreen()" aria-label="התחל משחק"><span class="interactive-icon">➡️</span> בואו נתחיל!</button>
            </div>
        </div>

        <!-- מסך הגדרת שחקנים -->
        <div id="players-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="title"><span class="interactive-icon">👫</span> פרטי השחקנים</div>
                <div class="card">
                    <div class="input-group">
                        <label for="player1-name">שם השחקן הראשון:</label>
                        <input type="text" id="player1-name" placeholder="הכנס שם" aria-required="true" maxlength="15">
                    </div>
                    <div class="input-group">
                        <label for="player1-gender">מגדר:</label>
                        <select id="player1-gender" aria-label="בחר מגדר עבור שחקן ראשון">
                            <option value="male">זכר</option>
                            <option value="female">נקבה</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="player2-name">שם השחקן השני:</label>
                        <input type="text" id="player2-name" placeholder="הכנס שם" aria-required="true" maxlength="15">
                    </div>
                    <div class="input-group">
                        <label for="player2-gender">מגדר:</label>
                        <select id="player2-gender" aria-label="בחר מגדר עבור שחקן שני">
                            <option value="male">זכר</option>
                            <option value="female">נקבה</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="screen-actions">
                <button class="btn" onclick="nextScreen()" aria-label="המשך לשלב הבא"><span class="interactive-icon">➡️</span> המשך</button>
            </div>
        </div>

        <!-- מסך פרס -->
        <div id="prize-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="title"><span class="interactive-icon">🏆</span> על מה אתם מתחרים?</div>
                <div class="card">
                    <div class="input-group">
                        <label for="prize">מה הפרס למנצח?</label>
                        <input type="text" id="prize" placeholder="לדוגמה: מסאז' של 30 דקות..." maxlength="50">
                    </div>
                </div>
            </div>
            <div class="screen-actions">
                <button class="btn" onclick="nextScreen()" aria-label="המשך לשלב הבא"><span class="interactive-icon">➡️</span> המשך</button>
            </div>
        </div>

        <!-- מסך הסבר -->
        <div id="rules-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="title"><span class="interactive-icon">📋</span> איך המשחק עובד?</div>
                <div class="card">
                    <ul style="text-align: right; line-height: 2.2; list-style: none; font-size: 1.1rem;">
                        <li><span class="interactive-icon">🎯</span> המשחק מורכב מ-6 חלקים עם 40 שאלות</li>
                        <li><span class="interactive-icon">🗣️</span> אתם עונים על השאלות בקול</li>
                        <li><span class="interactive-icon">✅</span> לוחצים על הכפתור של מי שהצליח</li>
                        <li><span class="interactive-icon">💥</span> כל 5 פסילות = משימה מיוחדת</li>
                        <li><span class="interactive-icon">⚠️</span> 3 פסילות רצופות = הודעת עידוד</li>
                        <li><span class="interactive-icon">🏆</span> בסוף נגלה מי המנצח!</li>
                    </ul>
                    
                    <div class="info-box">
                        <div class="input-group">
                            <label style="font-size: 1.2rem;">האם לכלול משימות חושניות במשחק?</label>
                            <div style="display: flex; align-items: center; justify-content: center; margin: 1rem 0;">
                                <span style="font-size: 1.1rem;">כן</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="sensual-tasks" checked aria-label="כלול משימות חושניות">
                                    <span class="slider"></span>
                                </label>
                                <span style="font-size: 1.1rem;">לא</span>
                            </div>
                            <div id="sensual-warning" class="sensual-warning">
                                <span class="interactive-icon">⚠️</span> בחירה ב"כן" תוסיף משימות אינטימיות למשחק
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="screen-actions">
                <button class="btn" onclick="startCountdown()" aria-label="התחל משחק"><span class="interactive-icon">🎮</span> מוכנים? בואו נתחיל!</button>
            </div>
        </div>

        <!-- מסך ספירה לאחור -->
        <div id="countdown-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="timer" id="countdown-timer" aria-live="polite">3</div>
            </div>
        </div>

        <!-- מסך כותרת חלק -->
        <div id="chapter-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="chapter-title" id="chapter-title"></div>
            </div>
            <div class="screen-actions">
                <button class="btn" onclick="startQuestions()" aria-label="התחל שאלות"><span class="interactive-icon">➡️</span> בואו נתחיל את החלק!</button>
            </div>
        </div>

        <!-- מסך משחק -->
        <div id="game-screen" class="screen" role="main">
            <div class="game-header">
                <div class="players-info">
                    <div class="player-card">
                        <div id="player1-display">שחקן 1</div>
                        <div class="failures"><span class="interactive-icon">❌</span> <span id="player1-failures">0</span></div>
                    </div>
                    <div class="player-card">
                        <div>שאלה <span id="current-question">1</span>/40</div>
                        <div class="progress-bar" role="progressbar" aria-valuenow="2.5" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-fill" id="progress-fill" style="width: 2.5%"></div>
                        </div>
                    </div>
                    <div class="player-card">
                        <div id="player2-display">שחקן 2</div>
                        <div class="failures"><span class="interactive-icon">❌</span> <span id="player2-failures">0</span></div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="question-card" id="question-display" role="alert" aria-live="polite">
                    שאלה תופיע כאן
                </div>
            </div>

            <div class="game-controls">
                <div class="controls">
                    <button class="btn btn-success" onclick="answerQuestion(1)" aria-label="שחקן ראשון ניצח">
                        <span class="interactive-icon">🏆</span> <span id="player1-btn">שחקן 1 ניצח</span>
                    </button>
                    <button class="btn btn-success" onclick="answerQuestion(2)" aria-label="שחקן שני ניצח">
                        <span class="interactive-icon">🏆</span> <span id="player2-btn">שחקן 2 ניצח</span>
                    </button>
                    <button class="btn btn-secondary" onclick="answerQuestion('both')" aria-label="שני השחקנים הצליחו">
                        <span class="interactive-icon">✅</span> שנינו הצלחנו
                    </button>
                    <button class="btn btn-danger" onclick="answerQuestion('none')" aria-label="שני השחקנים לא זכרו">
                        <span class="interactive-icon">❌</span> שנינו לא זכרנו
                    </button>
                </div>

                <div class="secondary-controls">
                    <button class="btn btn-warning" onclick="undoLastAction()" aria-label="בטל פעולה אחרונה"><span class="interactive-icon">🔁</span> בטל פעולה</button>
                </div>
            </div>
        </div>

        <!-- מסך תוצאות -->
        <div id="results-screen" class="screen" role="main">
            <div class="screen-content">
                <div class="title"><span class="interactive-icon">🏆</span> תוצאות המשחק!</div>
                <div class="card">
                    <div id="final-results"></div>
                </div>
            </div>
            <div class="screen-actions">
                <button class="btn btn-share" onclick="shareResults()" aria-label="שתף תוצאות בווטסאפ"><span class="interactive-icon">📱</span> שתף בווטסאפ</button>
                <button class="btn" onclick="restartGame()" aria-label="התחל משחק חדש"><span class="interactive-icon">🔄</span> משחק חדש</button>
            </div>
        </div>
    </div>

    <!-- פופאפים -->
    
    <!-- פופאפ הגדרות -->
    <div id="settings-popup" class="popup" role="dialog" aria-labelledby="settings-title">
        <div class="popup-content">
            <div class="title" id="settings-title"><span class="interactive-icon">⚙️</span> הגדרות</div>
            <div class="input-group">
                <label for="settings-player1-name">שם שחקן 1:</label>
                <input type="text" id="settings-player1-name" maxlength="15">
            </div>
            <div class="input-group">
                <label for="settings-player2-name">שם שחקן 2:</label>
                <input type="text" id="settings-player2-name" maxlength="15">
            </div>
            <div class="input-group">
                <label for="settings-prize">הפרס:</label>
                <input type="text" id="settings-prize" maxlength="50">
            </div>
            <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(255,255,255,0.1); border-radius: 15px;">
                <p style="margin-bottom: 1rem;"><span class="interactive-icon">💌</span> יצירת קשר:</p>
                <p>למשוב, הצעות או שאלות:</p>
                <p style="direction: ltr;">contact@memorygame.com</p>
            </div>
            <button class="btn btn-success" onclick="saveSettings()" aria-label="שמור שינויים"><span class="interactive-icon">💾</span> שמור שינויים</button>
            <button class="btn btn-secondary" onclick="closeSettings()" aria-label="סגור הגדרות"><span class="interactive-icon">❌</span> סגור</button>
        </div>
    </div>

    <!-- פופאפ הודעה על 5 פסילות -->
    <div id="failure-warning-popup" class="popup" role="dialog" aria-labelledby="failure-warning-title">
        <div class="popup-content">
            <div class="title" id="failure-warning-title" style="color: #ff6b6b;"><span class="interactive-icon">😱</span> אוי אוי אוי!</div>
            <div id="failure-warning-content" style="font-size: 1.4rem; margin: 2rem 0;"></div>
            <button class="btn btn-danger" onclick="showSensualTask()" aria-label="קבל משימה"><span class="interactive-icon">😈</span> כן, אני מוכן/ה למשימה!</button>
            <button class="btn btn-secondary" onclick="skipTask()" aria-label="דלג על משימה"><span class="interactive-icon">😅</span> אולי פעם הבאה...</button>
        </div>
    </div>

    <!-- פופאפ למשימה חושנית -->
    <div id="task-popup" class="popup" role="dialog" aria-labelledby="task-title">
        <div class="popup-content">
            <div class="title" id="task-title"><span class="interactive-icon">💕</span> המשימה שלך!</div>
            <div id="task-content" style="font-size: 1.3rem; margin: 2rem 0;"></div>
            <button class="btn btn-success" onclick="completeTask()" aria-label="סיים משימה"><span class="interactive-icon">✅</span> ביצעתי את המשימה</button>
        </div>
    </div>

    <!-- פופאפ להודעה על 3 פסילות רצופות -->
    <div id="message-popup" class="popup" role="dialog" aria-labelledby="message-title">
        <div class="popup-content">
            <div id="message-content"></div>
            <button class="btn" onclick="closeMessagePopup()" aria-label="סגור הודעה"><span class="interactive-icon">✅</span> הבנתי</button>
        </div>
    </div>

    <script>
        // משתני מערכת הצלילים
        let soundEnabled = true;
        let audioContext = null;
        let screenTransitionNumber = 0;
        let audioInitialized = false;
        let audioErrorCount = 0;
        let confettiElements = []; // מעקב אחר אלמנטי confetti

        // אתחול אודיו - רק אחרי אינטראקציה של המשתמש
        function initializeAudio() {
            if (audioInitialized) return;
            
            try {
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioInitialized = true;
                    
                    // במובייל, AudioContext נוצר ב-suspended state
                    if (audioContext.state === 'suspended' && typeof audioContext.resume === 'function') {
                        audioContext.resume().then(() => {
                            console.log('Audio context resumed');
                        }).catch(e => {
                            console.warn('Failed to resume audio context:', e);
                        });
                    }
                } else {
                    throw new Error('Web Audio API not supported');
                }
            } catch (e) {
                console.warn('Web Audio API not supported:', e);
                soundEnabled = false;
                updateSoundButton();
            }
        }

        // אתחול אודיו בהקלקה הראשונה
        function ensureAudioReady() {
            if (!audioInitialized && soundEnabled) {
                initializeAudio();
            }
            
            if (audioContext && audioContext.state === 'suspended' && typeof audioContext.resume === 'function') {
                audioContext.resume().catch(e => {
                    console.warn('Failed to resume audio:', e);
                });
            }
        }

        function playTone(frequency, duration, type = 'sine', volume = 0.1) {
            if (!soundEnabled) return;
            
            // ודא שהאודיו מוכן
            ensureAudioReady();
            
            if (!audioContext || audioContext.state === 'closed') {
                console.warn('Audio context not available');
                return;
            }
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
                
                // איפוס מונה השגיאות בהצלחה
                audioErrorCount = 0;
                
            } catch (e) {
                console.warn('Error playing sound:', e);
                audioErrorCount++;
                
                // אם יש יותר מדי שגיאות, כבה צלילים אוטומטית
                if (audioErrorCount > 3) {
                    soundEnabled = false;
                    updateSoundButton();
                    console.warn('Too many audio errors, disabling sound');
                }
            }
        }

        function playButtonClick() {
            playTone(800, 0.1, 'square', 0.05);
        }

        function playSuccess() {
            setTimeout(() => playTone(523.25, 0.15), 0);    // C5
            setTimeout(() => playTone(659.25, 0.15), 100);  // E5
            setTimeout(() => playTone(783.99, 0.3), 200);   // G5
        }

        function playError() {
            playTone(220, 0.3, 'sawtooth', 0.1);
        }

        function playTransition() {
            const transitions = [
                () => {
                    playTone(440, 0.1);
                    setTimeout(() => playTone(554.37, 0.1), 100);
                },
                () => {
                    playTone(659.25, 0.15);
                    setTimeout(() => playTone(783.99, 0.15), 100);
                },
                () => {
                    playTone(523.25, 0.1);
                    setTimeout(() => playTone(659.25, 0.1), 80);
                    setTimeout(() => playTone(783.99, 0.1), 160);
                }
            ];
            
            transitions[screenTransitionNumber % transitions.length]();
            screenTransitionNumber++;
        }

        function playCountdown() {
            playTone(800, 0.2, 'square', 0.08);
        }

        function playVictory() {
            const melody = [523.25, 659.25, 783.99, 1046.5]; // C-E-G-C
            melody.forEach((freq, index) => {
                setTimeout(() => playTone(freq, 0.3), index * 150);
            });
        }

        function updateSoundButton() {
            const soundBtn = document.getElementById('sound-toggle');
            if (!soundBtn) return;
            
            if (soundEnabled) {
                soundBtn.textContent = '🔊';
                soundBtn.classList.remove('muted');
                soundBtn.title = 'כבה צלילים';
                soundBtn.setAttribute('aria-label', 'כבה צלילים');
            } else {
                soundBtn.textContent = '🔇';
                soundBtn.classList.add('muted');
                soundBtn.title = 'הפעל צלילים';
                soundBtn.setAttribute('aria-label', 'הפעל צלילים');
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            updateSoundButton();
            
            if (soundEnabled) {
                // נסה לאתחל אודיו כשמפעילים
                initializeAudio();
                // נגן צליל בדיקה
                setTimeout(() => playButtonClick(), 100);
            }
        }

        // משתני המשחק
        let gameState = {
            currentScreen: 0,
            currentQuestion: 0,
            currentChapter: 0,
            player1: { name: '', gender: 'male', score: 0, failures: 0, consecutiveFailures: 0 },
            player2: { name: '', gender: 'male', score: 0, failures: 0, consecutiveFailures: 0 },
            prize: '',
            sensualTasks: true,
            currentTaskIndex: 0,
            lastAction: null,
            currentTaskPlayer: null,
            hasUsedUndo: false
        };

        const chapters = [
            {
                title: "🌟 חלק 1: זיכרונות קלאסיים",
                questions: [
                    "איפה היה הדייט הראשון שלכם?",
                    "מה הייתה ההזמנה האחרונה שהזמנתם בטייקאווי?",
                    "באיזה סרט צפיתם יחד בפעם האחרונה?",
                    "באיזה יום בשבוע היה הדייט הראשון שלכם?",
                    "איפה שתיתם קפה זוגי לאחרונה מחוץ לבית?",
                    "איפה חגגתם לראשונה משהו זוגי (כמו חודש, חצי שנה או יום הולדת)?"
                ]
            },
            {
                title: "⚡ חלק 2: הרגעים של עכשיו",
                questions: [
                    "איפה היה הדייט האחרון שלכם – רק שניכם שלא היה במסעדה?",
                    "מתי בפעם האחרונה אמרתם \"אני אוהב/ת אותך\"?",
                    "מה הייתה ההודעה האחרונה ששלחתם אחד לשני?",
                    "מתי בפעם האחרונה עשיתם פעילות ספורטיבית ביחד?",
                    "מה היה הסרט האחרון שראיתם יחד בקולנוע?",
                    "מתי בפעם האחרונה הלכתם יחד לחנות – ואיזו חנות זו הייתה?",
                    "מתי בפעם האחרונה נסעתם יחד במונית או אוטובוס – ולאן?",
                    "איפה הייתם כששניכם קמתם מאוחר במיוחד?"
                ]
            },
            {
                title: "👥 חלק 3: מפגשים חברתיים",
                questions: [
                    "איפה נפגשתם לראשונה עם המשפחה של PLAYER1?",
                    "מתי אירחתם אנשים בפעם האחרונה ומי היה?",
                    "מתי עשיתם ערב חג ראשון אצל המשפחה של PLAYER2?",
                    "מתי הייתה הפעם האחרונה שנפגשתם עם חברים משותפים – ואצל מי זה היה?",
                    "איפה פגשתם לראשונה את החברים הכי קרובים של PLAYER1?",
                    "מה היה האירוע החברתי האחרון שהייתם בו יחד – ואיפה זה היה?"
                ]
            },
            {
                title: "🔄 חלק 4: מה קרה בפעם האחרונה ש...",
                questions: [
                    "איפה הייתם בפעם האחרונה שישנתם מחוץ לבית?",
                    "מה היה המקום האחרון שבו אכלתם יחד בחוץ (מסעדה/בית קפה)?",
                    "מה היה הסרט האחרון שראיתם יחד בבית?",
                    "מה היה המשלוח האחרון שקיבלתם יחד (אוכל או חבילה)?"
                ]
            },
            {
                title: "💝 חלק 5: אירועים זוגיים מיוחדים",
                questions: [
                    "איפה חגגתם בפעם הראשונה יום הולדת (של אחד מכם)?",
                    "איפה הייתם ביום האהבה הראשון שלכם (ולנטיין / ט\"ו באב)?",
                    "מתי בפעם האחרונה עשיתם יחד יום כיף בבית? (מרתון טלוויזיה, אוכל טוב וכו')",
                    "מתי הייתה הפעם האחרונה שקניתם אחד לשני מתנה שלא ליום הולדת – ומה הייתה המתנה?",
                    "איזו הודעה משמחת או חשובה קיבל אחד מכם לאחרונה – ומה עשיתם באותו רגע?",
                    "מתי ואיפה הייתם כשקיבלתם יחד החלטה על משהו משמעותי – כמו לקנות משהו גדול, לשנות כיוון או להתחיל משהו חדש?"
                ]
            },
            {
                title: "🎭 חלק 6: מאחורי הקלעים של הזוגיות",
                questions: [
                    "מי התחיל עם מי?",
                    "מי בחר את המקום שבו היה הדייט הראשון שלכם?",
                    "מתי החלטתם רשמית שאתם זוג?",
                    "מי יזם את הפעם האחרונה שנסעתם לחופשה יחד?",
                    "מי זה שהביא את הרעיון לבלות את הסופ\"ש האחרון כמו שהוא היה?",
                    "מי בחר את הסדרה האחרונה שראיתם יחד?",
                    "מי הציע לעשות משהו רומנטי בפעם האחרונה – ומה זה היה?",
                    "מי זה שבחר את המסעדה האחרונה?",
                    "מי אמר \"אני אוהב/ת אותך\" בפעם האחרונה – ומתי זה היה?",
                    "רגע של שיתוף – מתי הייתה הפעם האחרונה שהסתכלתם אחד על השני וחשבתם \"איזה מזל שאנחנו יחד\"? ואיפה זה היה?"
                ]
            }
        ];

        const sensualTasks = [
            "PLAYER1, שב/י על הברכיים של PLAYER2 והביטו אחד לשני בעיניים במשך דקה – בלי לחייך.",
            "PLAYER1, תן/י לPLAYER2 נשיקה ארוכה של דקה – בלי להפסיק.",
            "PLAYER1, הורד/י את החולצה שלך.",
            "PLAYER1, לחש/י משפט מיני באוזן של PLAYER2.",
            "PLAYER1, לקק/י בעדינות את השפתיים של PLAYER2 – למשך 10 שניות.",
            "PLAYER1, נשק/י את PLAYER2 בשלושה מקומות אינטימיים בגוף.",
            "PLAYER1, הורד/י את המכנס שלך או של PLAYER2.",
            "PLAYER1, תאר/י בקצרה פנטזיה מינית שיש לך.",
            "שניכם - הדגימו תנוחה אהובה (בלבוש בלבד) – בלי מילים.",
            "PLAYER1, העבר/י את הלשון לאורך אזור בגוף של PLAYER2 – לפי בחירתו/ה."
        ];

        const encouragementMessages = [
            { type: 'tease', message: 'PLAYER, את/ה ממש מתקשה להיזכר! OTHER_PLAYER, תתכונן/י לניצחון!' },
            { type: 'encourage', message: 'PLAYER, אל תתייאש/י - עוד רגע את/ה חוזר/ת לעצמך!' },
            { type: 'compliment', message: 'OTHER_PLAYER, את/ה מדהים/ה! שלוש הצלחות רצופות זה לא מובן מאליו.' },
            { type: 'funny', message: 'PLAYER, נראה שהזיכרון שלך יצא לחופשה... OTHER_PLAYER מוביל/ה!' },
            { type: 'motivate', message: 'PLAYER, זה הזמן לחזור למשחק! OTHER_PLAYER, תיזהר/י - הוא/היא עוד יחזור/תחזור!' },
            { type: 'sweet', message: 'אולי PLAYER לא זוכר/ת הכל, אבל OTHER_PLAYER בטוח זוכר/ת למה הוא/היא התאהב/ה!' },
            { type: 'challenge', message: 'OTHER_PLAYER, נראה שיש לך זיכרון של פיל! PLAYER, תראה/י לו/לה מה את/ה יודע/ת!' },
            { type: 'romantic', message: 'PLAYER, אולי הזיכרון בוגד בך, אבל האהבה שלכם חזקה מתמיד!' },
            { type: 'playful', message: 'PLAYER צריך/ה כנראה ויטמינים לזיכרון... OTHER_PLAYER, אל תרחם/י!' },
            { type: 'supportive', message: 'זה בסדר PLAYER, לא תמיד זוכרים הכל. OTHER_PLAYER, תן/י לו/לה צ\'אנס!' }
        ];

        function getGenderText(gender, maleText, femaleText) {
            return gender === 'male' ? maleText : femaleText;
        }

        function getGenderVerb(gender, maleVerb, femaleVerb) {
            return gender === 'male' ? maleVerb : femaleVerb;
        }

        function getGenderAddress(gender, maleAddress, femaleAddress) {
            return gender === 'male' ? maleAddress : femaleAddress;
        }

        function updateButtonTexts() {
            const player1Verb = getGenderVerb(gameState.player1.gender, 'ניצח', 'ניצחה');
            const player2Verb = getGenderVerb(gameState.player2.gender, 'ניצח', 'ניצחה');
            
            document.getElementById('player1-btn').textContent = `${gameState.player1.name} ${player1Verb}`;
            document.getElementById('player2-btn').textContent = `${gameState.player2.name} ${player2Verb}`;
        }

        function replacePlayerNames(text) {
            return text
                .replace(/PLAYER1/g, gameState.player1.name)
                .replace(/PLAYER2/g, gameState.player2.name);
        }

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showScreen(screenId, animation = 'fadeInUp') {
            const currentScreen = document.querySelector('.screen.active');
            const nextScreen = document.getElementById(screenId);
            
            if (currentScreen) {
                currentScreen.classList.remove('active');
            }
            
            nextScreen.classList.add('active');
            
            // הוספת אנימציה
            nextScreen.classList.remove('slide-right', 'slide-left', 'zoom');
            if (animation === 'slideRight') {
                nextScreen.classList.add('slide-right');
            } else if (animation === 'slideLeft') {
                nextScreen.classList.add('slide-left');
            } else if (animation === 'zoom') {
                nextScreen.classList.add('zoom');
            }
            
            playTransition();
        }

        function showErrorMessage(message) {
            // מחיקת הודעות שגיאה קודמות
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const activeScreen = document.querySelector('.screen.active .screen-content');
            if (activeScreen) {
                activeScreen.appendChild(errorDiv);
                
                // הסרת ההודעה אחרי 4 שניות
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 4000);
            }
        }

        function nextScreen() {
            playButtonClick();
            
            if (gameState.currentScreen === 1) { // מסך שחקנים
                if (!savePlayersInfo()) return;
            } else if (gameState.currentScreen === 2) { // מסך פרס
                savePrizeInfo();
            }

            const screens = ['welcome-screen', 'players-screen', 'prize-screen', 'rules-screen'];
            gameState.currentScreen++;

            if (gameState.currentScreen < screens.length) {
                showScreen(screens[gameState.currentScreen], 'slideRight');
            }
        }

        function validateName(name) {
            if (!name || name.trim().length === 0) {
                return 'אנא הכנס שם';
            }
            if (name.trim().length < 2) {
                return 'השם חייב להכיל לפחות 2 תווים';
            }
            if (name.trim().length > 15) {
                return 'השם לא יכול להכיל יותר מ-15 תווים';
            }
            // regex מעודכן שמאפשר יותר תווים (כולל apostrophe ומקף)
            if (!/^[\u0590-\u05FFa-zA-Z\s\u200E\u200F'\-\.]+$/.test(name.trim())) {
                return 'השם יכול להכיל רק אותיות, רווחים, מקפים ו apostrophe';
            }
            return null;
        }

        function savePlayersInfo() {
            const player1Name = document.getElementById('player1-name').value.trim();
            const player2Name = document.getElementById('player2-name').value.trim();
            
            // בדיקת validation
            const player1Error = validateName(player1Name);
            const player2Error = validateName(player2Name);
            
            if (player1Error) {
                playError();
                showErrorMessage(`שגיאה בשם השחקן הראשון: ${player1Error}`);
                return false;
            }
            
            if (player2Error) {
                playError();
                showErrorMessage(`שגיאה בשם השחקן השני: ${player2Error}`);
                return false;
            }
            
            if (player1Name.toLowerCase() === player2Name.toLowerCase()) {
                playError();
                showErrorMessage('שמות השחקנים חייבים להיות שונים');
                return false;
            }

            gameState.player1.name = player1Name;
            gameState.player1.gender = document.getElementById('player1-gender').value;
            gameState.player2.name = player2Name;
            gameState.player2.gender = document.getElementById('player2-gender').value;

            document.getElementById('player1-display').textContent = sanitizeHTML(player1Name);
            document.getElementById('player2-display').textContent = sanitizeHTML(player2Name);
            updateButtonTexts();

            playSuccess();
            return true;
        }

        function savePrizeInfo() {
            gameState.prize = document.getElementById('prize').value.trim() || 'הנצחון!';
            playSuccess();
        }

        function startCountdown() {
            playButtonClick();
            gameState.sensualTasks = document.getElementById('sensual-tasks').checked;
            showScreen('countdown-screen', 'zoom');
            let count = 3;
            const timer = document.getElementById('countdown-timer');
            
            const countdown = setInterval(() => {
                if (count > 0) {
                    timer.textContent = count;
                    playCountdown();
                    count--;
                } else if (count === 0) {
                    timer.textContent = 'בהצלחה! 🎮';
                    playVictory();
                    count--;
                } else {
                    clearInterval(countdown);
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            gameState.currentQuestion = 0;
            gameState.currentChapter = 0;
            showChapter();
        }

        function showChapter() {
            if (gameState.currentChapter < chapters.length) {
                document.getElementById('chapter-title').textContent = chapters[gameState.currentChapter].title;
                showScreen('chapter-screen', 'zoom');
            } else {
                showResults();
            }
        }

        function startQuestions() {
            playButtonClick();
            showScreen('game-screen', 'slideLeft');
            displayCurrentQuestion();
        }

        function displayCurrentQuestion() {
            const chapter = chapters[gameState.currentChapter];
            const questionIndex = gameState.currentQuestion - getTotalQuestionsBeforeChapter(gameState.currentChapter);
            
            if (questionIndex < chapter.questions.length) {
                let questionText = chapter.questions[questionIndex];
                questionText = replacePlayerNames(questionText);
                document.getElementById('question-display').textContent = questionText;
                
                document.getElementById('current-question').textContent = gameState.currentQuestion + 1;
                
                const progress = ((gameState.currentQuestion + 1) / getTotalQuestions()) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                
                // עדכון progressbar עבור נגישות
                const progressBar = document.querySelector('.progress-bar');
                progressBar.setAttribute('aria-valuenow', progress.toFixed(1));
                
                updateScoreDisplay();
            } else {
                gameState.currentChapter++;
                if (gameState.currentChapter < chapters.length) {
                    showChapter();
                } else {
                    showResults();
                }
            }
        }

        function getTotalQuestions() {
            return chapters.reduce((total, chapter) => total + chapter.questions.length, 0);
        }

        function getTotalQuestionsBeforeChapter(chapterIndex) {
            let total = 0;
            for (let i = 0; i < chapterIndex; i++) {
                total += chapters[i].questions.length;
            }
            return total;
        }

        function checkForSensualTask() {
            if (!gameState.sensualTasks) return;

            let taskPlayer = null;
            if (gameState.player1.failures >= 5) {
                taskPlayer = gameState.player1;
                gameState.currentTaskPlayer = gameState.player1;
                gameState.player1.failures = 0; // איפוס לאחר הגעה ל-5
            } else if (gameState.player2.failures >= 5) {
                taskPlayer = gameState.player2;
                gameState.currentTaskPlayer = gameState.player2;
                gameState.player2.failures = 0; // איפוס לאחר הגעה ל-5
            }

            if (taskPlayer) {
                if (gameState.currentTaskIndex >= sensualTasks.length) {
                    gameState.currentTaskIndex = 0;
                    showMessage(`נגמרו המשימות! חוזרים להתחלה... 😏`);
                    setTimeout(() => {
                        showFailureWarning(taskPlayer);
                    }, 2000);
                } else {
                    showFailureWarning(taskPlayer);
                }
            }
        }

        function answerQuestion(answer) {
            playButtonClick();
            
            // שמירת מצב רק אם לא השתמשו ב-undo
            gameState.lastAction = {
                question: gameState.currentQuestion,
                chapter: gameState.currentChapter,
                player1Score: gameState.player1.score,
                player2Score: gameState.player2.score,
                player1Failures: gameState.player1.failures,
                player2Failures: gameState.player2.failures,
                player1ConsecutiveFailures: gameState.player1.consecutiveFailures,
                player2ConsecutiveFailures: gameState.player2.consecutiveFailures
            };
            
            // איפוס הדגל של undo לאחר שמירת מצב חדש
            gameState.hasUsedUndo = false;

            let willHaveFiveFailures = false;
            
            if (answer === 1) {
                gameState.player1.score++;
                gameState.player1.consecutiveFailures = 0;
                gameState.player2.failures++;
                gameState.player2.consecutiveFailures++;
                if (gameState.player2.failures === 5) willHaveFiveFailures = true;
                playSuccess();
            } else if (answer === 2) {
                gameState.player2.score++;
                gameState.player2.consecutiveFailures = 0;
                gameState.player1.failures++;
                gameState.player1.consecutiveFailures++;
                if (gameState.player1.failures === 5) willHaveFiveFailures = true;
                playSuccess();
            } else if (answer === 'both') {
                gameState.player1.score++;
                gameState.player2.score++;
                gameState.player1.consecutiveFailures = 0;
                gameState.player2.consecutiveFailures = 0;
                playVictory();
            } else if (answer === 'none') {
                gameState.player1.failures++;
                gameState.player2.failures++;
                gameState.player1.consecutiveFailures++;
                gameState.player2.consecutiveFailures++;
                if (gameState.player1.failures === 5 || gameState.player2.failures === 5) willHaveFiveFailures = true;
                playError();
            }

            // בדיקת הודעות עידוד רק אם לא תהיה משימה
            if (!willHaveFiveFailures) {
                checkForEncouragementMessage();
            }
            
            checkForSensualTask();
            
            gameState.currentQuestion++;
            displayCurrentQuestion();
        }

        function checkForEncouragementMessage() {
            let messagePlayer = null;
            let otherPlayer = null;

            // שמירת מצב קודם לפני איפוס
            const player1Had3Failures = gameState.player1.consecutiveFailures === 3;
            const player2Had3Failures = gameState.player2.consecutiveFailures === 3;

            if (player1Had3Failures) {
                messagePlayer = gameState.player1;
                otherPlayer = gameState.player2;
                gameState.player1.consecutiveFailures = 0; // איפוס אחרי הצגת הודעה
            } else if (player2Had3Failures) {
                messagePlayer = gameState.player2;
                otherPlayer = gameState.player1;
                gameState.player2.consecutiveFailures = 0; // איפוס אחרי הצגת הודעה
            }

            if (messagePlayer) {
                const messageType = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                
                // החלפת שמות בצורה בטוחה
                let message = messageType.message;
                
                // יצירת placeholders זמניים כדי למנוע התנגשויות
                const playerPlaceholder = '###CURRENT_PLAYER###';
                const otherPlaceholder = '###OTHER_PLAYER###';
                
                // החלפה ראשונית ל-placeholders
                message = message.replace(/OTHER_PLAYER/g, otherPlaceholder);
                message = message.replace(/PLAYER/g, playerPlaceholder);
                
                // החלפה סופית לשמות האמיתיים
                message = message.replace(new RegExp(playerPlaceholder, 'g'), messagePlayer.name);
                message = message.replace(new RegExp(otherPlaceholder, 'g'), otherPlayer.name);

                // התאמה לפי מגדר השחקן הנוכחי
                if (messagePlayer.gender === 'female') {
                    message = message
                        .replace(/את\/ה/g, 'את')
                        .replace(/מתקשה/g, 'מתקשה')
                        .replace(/תתייאש\/י/g, 'תתייאשי')
                        .replace(/חוזר\/ת/g, 'חוזרת')
                        .replace(/זוכר\/ת/g, 'זוכרת')
                        .replace(/יודע\/ת/g, 'יודעת')
                        .replace(/צריך\/ה/g, 'צריכה')
                        .replace(/תראה\/י/g, 'תראי')
                        .replace(/לו\/לה/g, 'לה')
                        .replace(/הוא\/היא/g, 'היא')
                        .replace(/יחזור\/תחזור/g, 'תחזור');
                } else {
                    message = message
                        .replace(/את\/ה/g, 'אתה')
                        .replace(/תתייאש\/י/g, 'תתייאש')
                        .replace(/חוזר\/ת/g, 'חוזר')
                        .replace(/זוכר\/ת/g, 'זוכר')
                        .replace(/יודע\/ת/g, 'יודע')
                        .replace(/צריך\/ה/g, 'צריך')
                        .replace(/תראה\/י/g, 'תראה')
                        .replace(/לו\/לה/g, 'לו')
                        .replace(/הוא\/היא/g, 'הוא')
                        .replace(/יחזור\/תחזור/g, 'יחזור');
                }

                // התאמה לפי מגדר השחקן השני
                if (otherPlayer.gender === 'female') {
                    message = message
                        .replace(/תתכונן\/י/g, 'תתכונני')
                        .replace(/מדהים\/ה/g, 'מדהימה')
                        .replace(/מוביל\/ה/g, 'מובילה')
                        .replace(/תיזהר\/י/g, 'תיזהרי')
                        .replace(/התאהב\/ה/g, 'התאהבה')
                        .replace(/תן\/י/g, 'תני')
                        .replace(/תרחם\/י/g, 'תרחמי')
                        .replace(/זוכר\/ת/g, 'זוכרת');
                } else {
                    message = message
                        .replace(/תתכונן\/י/g, 'תתכונן')
                        .replace(/מדהים\/ה/g, 'מדהים')
                        .replace(/מוביל\/ה/g, 'מוביל')
                        .replace(/תיזהר\/י/g, 'תיזהר')
                        .replace(/התאהב\/ה/g, 'התאהב')
                        .replace(/תן\/י/g, 'תן')
                        .replace(/תרחם\/י/g, 'תרחם')
                        .replace(/זוכר\/ת/g, 'זוכר');
                }

                showMessage(message);
            }
        }

        function showFailureWarning(player) {
            const genderReady = getGenderAddress(player.gender, 'מוכן', 'מוכנה');
            const genderReceive = getGenderVerb(player.gender, 'תקבל', 'תקבלי');
            
            document.getElementById('failure-warning-content').innerHTML = `
                <strong>${sanitizeHTML(player.name)}, הגעת ל-5 פסילות!</strong><br><br>
                לכן ${genderReceive} משימה מינית במיוחד...<br><br>
                ${genderReady} למשימה שלך? 😏
            `;
            
            // עדכון טקסט הכפתור
            const readyButton = document.querySelector('#failure-warning-popup .btn-danger');
            readyButton.innerHTML = `<span class="interactive-icon">😈</span> כן, אני ${genderReady} למשימה!`;
            
            document.getElementById('failure-warning-popup').style.display = 'flex';
        }

        function showSensualTask() {
            playButtonClick();
            document.getElementById('failure-warning-popup').style.display = 'none';
            
            let task = sensualTasks[gameState.currentTaskIndex];
            const currentPlayer = gameState.currentTaskPlayer;
            const otherPlayer = currentPlayer === gameState.player1 ? gameState.player2 : gameState.player1;
            
            task = task.replace(/PLAYER1/g, currentPlayer.name).replace(/PLAYER2/g, otherPlayer.name);
            
            if (currentPlayer.gender === 'female') {
                task = task.replace(/שב\/י/g, 'שבי')
                          .replace(/תן\/י/g, 'תני')
                          .replace(/הורד\/י/g, 'הורידי')
                          .replace(/לחש\/י/g, 'לחשי')
                          .replace(/לקק\/י/g, 'לקקי')
                          .replace(/נשק\/י/g, 'נשקי')
                          .replace(/תאר\/י/g, 'תארי')
                          .replace(/העבר\/י/g, 'העבירי');
            }
            else {
                task = task.replace(/שב\/י/g, 'שב')
                          .replace(/תן\/י/g, 'תן')
                          .replace(/הורד\/י/g, 'הורד')
                          .replace(/לחש\/י/g, 'לחש')
                          .replace(/לקק\/י/g, 'לקק')
                          .replace(/נשק\/י/g, 'נשק')
                          .replace(/תאר\/י/g, 'תאר')
                          .replace(/העבר\/י/g, 'העבר');
            }
            
            if (otherPlayer.gender === 'female') {
                task = task.replace(/בחירתו\/ה/g, 'בחירתה');
            } else {
                task = task.replace(/בחירתו\/ה/g, 'בחירתו');
            }
            
            document.getElementById('task-content').innerHTML = `
                <div style="padding: 1rem; background: rgba(255,255,255,0.2); border-radius: 15px; font-size: 1.4rem; line-height: 1.6;">
                    ${sanitizeHTML(task)}
                </div>
            `;
            
            document.getElementById('task-popup').style.display = 'flex';
            gameState.currentTaskIndex++;
        }

        function skipTask() {
            playButtonClick();
            document.getElementById('failure-warning-popup').style.display = 'none';
        }

        function completeTask() {
            playButtonClick();
            playSuccess();
            document.getElementById('task-popup').style.display = 'none';
        }

        function showMessage(message) {
            document.getElementById('message-content').innerHTML = `
                <div style="font-size: 1.4rem; padding: 1.5rem; line-height: 1.6;">
                    ${sanitizeHTML(message)}
                </div>
            `;
            document.getElementById('message-popup').style.display = 'flex';
        }

        function closeMessagePopup() {
            playButtonClick();
            document.getElementById('message-popup').style.display = 'none';
        }

        function undoLastAction() {
            playButtonClick();
            
            if (!gameState.lastAction) {
                playError();
                showMessage('אין פעולה לביטול');
                return;
            }

            if (gameState.hasUsedUndo) {
                playError();
                showMessage('ניתן לבטל רק פעם אחת');
                return;
            }

            gameState.currentQuestion = gameState.lastAction.question;
            gameState.currentChapter = gameState.lastAction.chapter;
            gameState.player1.score = gameState.lastAction.player1Score;
            gameState.player2.score = gameState.lastAction.player2Score;
            gameState.player1.failures = gameState.lastAction.player1Failures;
            gameState.player2.failures = gameState.lastAction.player2Failures;
            gameState.player1.consecutiveFailures = gameState.lastAction.player1ConsecutiveFailures;
            gameState.player2.consecutiveFailures = gameState.lastAction.player2ConsecutiveFailures;
            
            gameState.hasUsedUndo = true;
            displayCurrentQuestion();
            playSuccess();
            showMessage('הפעולה בוטלה');
        }

        function updateScoreDisplay() {
            document.getElementById('player1-failures').textContent = gameState.player1.failures;
            document.getElementById('player2-failures').textContent = gameState.player2.failures;
        }

        function createConfetti() {
            cleanupConfetti(); // נקה confetti ישן לפני יצירת חדש
            
            const colors = ['#ff0084', '#00ffff', '#ffeaa7', '#fab1a0', '#74b9ff'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    document.body.appendChild(confetti);
                    
                    // הוספה למעקב
                    confettiElements.push(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.remove();
                        }
                        // הסרה מהמעקב
                        const index = confettiElements.indexOf(confetti);
                        if (index > -1) {
                            confettiElements.splice(index, 1);
                        }
                    }, 5000);
                }, i * 50);
            }
        }

        function cleanupConfetti() {
            confettiElements.forEach(confetti => {
                if (confetti.parentNode) {
                    confetti.remove();
                }
            });
            confettiElements = [];
        }

        function showResults() {
            const player1Score = gameState.player1.score;
            const player2Score = gameState.player2.score;
            let winner, winnerGender;
            
            if (player1Score > player2Score) {
                winner = gameState.player1.name;
                winnerGender = gameState.player1.gender;
                createConfetti();
                playVictory();
            } else if (player2Score > player1Score) {
                winner = gameState.player2.name;
                winnerGender = gameState.player2.gender;
                createConfetti();
                playVictory();
            } else {
                winner = null;
                playVictory();
            }

            let resultsHTML = `
                <div style="text-align: center;">
                    <h2 style="font-size: 2rem; margin-bottom: 3rem;"><span class="interactive-icon">📊</span> תוצאות סופיות</h2>
                    <div style="display: flex; justify-content: space-around; margin: 3rem 0; flex-wrap: wrap;">
                        <div style="margin: 2rem; min-width: 200px;">
                            <h3 style="font-size: 1.8rem; margin-bottom: 1rem;">${sanitizeHTML(gameState.player1.name)}</h3>
                            <div class="score-animation" style="font-size: 3rem;">${player1Score}</div>
                            <div style="font-size: 1.2rem; margin-top: 0.5rem;">נקודות</div>
                        </div>
                        <div style="margin: 2rem; min-width: 200px;">
                            <h3 style="font-size: 1.8rem; margin-bottom: 1rem;">${sanitizeHTML(gameState.player2.name)}</h3>
                            <div class="score-animation" style="font-size: 3rem;">${player2Score}</div>
                            <div style="font-size: 1.2rem; margin-top: 0.5rem;">נקודות</div>
                        </div>
                    </div>
            `;

            if (winner) {
                const winnerVerb = getGenderVerb(winnerGender, 'ניצח', 'ניצחה');
                resultsHTML += `
                    <div style="background: linear-gradient(45deg, #ffeaa7, #fab1a0); color: #333; padding: 3rem; border-radius: 25px; margin: 3rem 0; animation: pulse 2s infinite;">
                        <h3 style="font-size: 2rem; margin-bottom: 1rem;"><span class="interactive-icon">🏆</span> ${sanitizeHTML(winner)} ${winnerVerb}!</h3>
                        <p style="font-size: 1.4rem; margin-top: 1.5rem;">
                            הפרס ${getGenderAddress(winnerGender, 'שלך', 'שלך')}: <strong>${sanitizeHTML(gameState.prize)}</strong>
                        </p>
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div style="background: linear-gradient(45deg, #74b9ff, #0984e3); padding: 3rem; border-radius: 25px; margin: 3rem 0; animation: pulse 2s infinite;">
                        <h3 style="font-size: 2rem; margin-bottom: 1rem;"><span class="interactive-icon">🤝</span> תיקו!</h3>
                        <p style="font-size: 1.4rem; margin-top: 1.5rem;">
                            שניכם זוכים ב: <strong>${sanitizeHTML(gameState.prize)}</strong>
                        </p>
                    </div>
                `;
            }

            resultsHTML += `
                    <div style="margin-top: 3rem; font-size: 1.2rem; line-height: 1.8;">
                        <p><span class="interactive-icon">💕</span> תודה שיחקתם במשחק הזיכרון הגדול!</p>
                        <p>איזה כיף לראות כמה אתם מכירים אחד את השני!</p>
                    </div>
                </div>
            `;

            document.getElementById('final-results').innerHTML = resultsHTML;
            showScreen('results-screen', 'zoom');
        }

        function shareResults() {
            playButtonClick();
            
            const player1Score = gameState.player1.score;
            const player2Score = gameState.player2.score;
            let winner = '';
            
            if (player1Score > player2Score) {
                const winnerVerb = getGenderVerb(gameState.player1.gender, 'ניצח', 'ניצחה');
                winner = `🏆 ${gameState.player1.name} ${winnerVerb}!`;
            } else if (player2Score > player1Score) {
                const winnerVerb = getGenderVerb(gameState.player2.gender, 'ניצח', 'ניצחה');
                winner = `🏆 ${gameState.player2.name} ${winnerVerb}!`;
            } else {
                winner = '🤝 תיקו!';
            }

            const message = `🎮 סיימנו את משחק הזיכרון הגדול!\n\n` +
                          `${gameState.player1.name}: ${player1Score} נקודות\n` +
                          `${gameState.player2.name}: ${player2Score} נקודות\n\n` +
                          `${winner}\n\n` +
                          `הפרס: ${gameState.prize}\n\n` +
                          `💕 היה כיף לראות כמה אנחנו מכירים אחד את השני!`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function showConfirmDialog(title, message, onConfirm, onCancel) {
            // יצירת popup אישור
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.style.display = 'flex';
            popup.setAttribute('role', 'dialog');
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="title">${sanitizeHTML(title)}</div>
                    <div style="font-size: 1.2rem; margin: 2rem 0; line-height: 1.6;">
                        ${sanitizeHTML(message)}
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-danger" id="confirm-yes">✅ כן, התחל משחק חדש</button>
                        <button class="btn btn-secondary" id="confirm-no">❌ לא, המשך במשחק הנוכחי</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            document.getElementById('confirm-yes').addEventListener('click', () => {
                document.body.removeChild(popup);
                onConfirm();
            });
            
            document.getElementById('confirm-no').addEventListener('click', () => {
                document.body.removeChild(popup);
                onCancel();
            });
        }

        function doRestartGame() {
            // ניקוי confetti
            cleanupConfetti();
            
            gameState = {
                currentScreen: 0,
                currentQuestion: 0,
                currentChapter: 0,
                player1: { name: '', gender: 'male', score: 0, failures: 0, consecutiveFailures: 0 },
                player2: { name: '', gender: 'male', score: 0, failures: 0, consecutiveFailures: 0 },
                prize: '',
                sensualTasks: true,
                currentTaskIndex: 0,
                lastAction: null,
                currentTaskPlayer: null,
                hasUsedUndo: false
            };

            document.getElementById('player1-name').value = '';
            document.getElementById('player2-name').value = '';
            document.getElementById('prize').value = '';
            document.getElementById('sensual-tasks').checked = true;

            showScreen('welcome-screen', 'zoom');
        }
           
        function restartGame() {
            playButtonClick();
            
            const currentProgress = gameState.currentQuestion;
            if (currentProgress > 5) { // רק אם יש התקדמות משמעותית
                showConfirmDialog(
                    '🔄 האם להתחיל משחק חדש?',
                    `כבר ענית על ${currentProgress} שאלות. כל ההתקדמות תאבד.`,
                    () => doRestartGame(),
                    () => {} // ביטול - לא עושה כלום
                );
            } else {
                doRestartGame();
            }
        }

        function openSettings() {
            playButtonClick();
            document.getElementById('settings-player1-name').value = gameState.player1.name;
            document.getElementById('settings-player2-name').value = gameState.player2.name;
            document.getElementById('settings-prize').value = gameState.prize;
            document.getElementById('settings-popup').style.display = 'flex';
        }

        function saveSettings() {
            playButtonClick();
            
            // validation עבור שמות בהגדרות
            const newPlayer1Name = document.getElementById('settings-player1-name').value.trim();
            const newPlayer2Name = document.getElementById('settings-player2-name').value.trim();
            
            if (newPlayer1Name && validateName(newPlayer1Name)) {
                showMessage(`שגיאה בשם שחקן 1: ${validateName(newPlayer1Name)}`);
                return;
            }
            
            if (newPlayer2Name && validateName(newPlayer2Name)) {
                showMessage(`שגיאה בשם שחקן 2: ${validateName(newPlayer2Name)}`);
                return;
            }
            
            if (newPlayer1Name && newPlayer2Name && newPlayer1Name.toLowerCase() === newPlayer2Name.toLowerCase()) {
                showMessage('שמות השחקנים חייבים להיות שונים');
                return;
            }
            
            gameState.player1.name = newPlayer1Name || gameState.player1.name;
            gameState.player2.name = newPlayer2Name || gameState.player2.name;
            gameState.prize = document.getElementById('settings-prize').value.trim() || gameState.prize;
            
            document.getElementById('player1-display').textContent = sanitizeHTML(gameState.player1.name);
            document.getElementById('player2-display').textContent = sanitizeHTML(gameState.player2.name);
            updateButtonTexts();
            
            closeSettings();
            playSuccess();
            showMessage('ההגדרות נשמרו בהצלחה!');
        }

        function closeSettings() {
            playButtonClick();
            document.getElementById('settings-popup').style.display = 'none';
        }

        // מניעת גלילה בטעות במובייל
        function preventScroll(e) {
            if (e.target.closest('.popup-content')) return;
            if (e.target.closest('.screen.active')) {
                e.preventDefault();
            }
        }

        // טיפול בלחיצות מקלדת
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                const activeScreen = document.querySelector('.screen.active');
                if (activeScreen) {
                    const nextButton = activeScreen.querySelector('.btn:not(.btn-secondary):not(.btn-warning)');
                    if (nextButton && !nextButton.disabled) {
                        nextButton.click();
                    }
                }
            } else if (e.key === 'Escape') {
                // סגירת פופאפים בESC
                const openPopups = document.querySelectorAll('.popup[style*="flex"]');
                openPopups.forEach(popup => {
                    popup.style.display = 'none';
                });
            }
        }

        // אתחול המערכת
        document.addEventListener('DOMContentLoaded', function() {
            // אתחול כפתור הסאונד
            updateSoundButton();

            // אתחול אודיו בהקלקה הראשונה על כל דבר
            document.addEventListener('click', function(e) {
                ensureAudioReady();
            }, { once: true });

            // אתחול אודיו גם במגע (למובייל)
            document.addEventListener('touchstart', function(e) {
                ensureAudioReady();
            }, { once: true });
                
            // הגדרת מתג המשימות החושניות
            const sensualToggle = document.getElementById('sensual-tasks');
            const warning = document.getElementById('sensual-warning');
            
            function updateSensualWarning() {
                if (sensualToggle.checked) {
                    warning.style.display = 'block';
                    warning.innerHTML = '<span class="interactive-icon">⚠️</span> בחירה ב"כן" תוסיף משימות אינטימיות למשחק';
                    warning.className = 'sensual-warning';
                } else {
                    warning.style.display = 'block';
                    warning.innerHTML = '<span class="interactive-icon">✅</span> לא יהיו משימות אינטימיות במשחק';
                    warning.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                    warning.style.animation = 'none';
                }
            }
            
            sensualToggle.addEventListener('change', updateSensualWarning);
            updateSensualWarning();

            // מניעת גלילה בטעות במובייל
            document.addEventListener('touchmove', preventScroll, { passive: false });

            // טיפול באירועי מקלדת
            document.addEventListener('keydown', handleKeyPress);
            
            // ניקוי במעבר דף
            window.addEventListener('beforeunload', cleanupConfetti);
        });
    </script>
</body>
</html>
